From 2cc227f0265fa5498075e34b9ced2fb620c2a0fe Mon Sep 17 00:00:00 2001
From: Timotheus Pokorra <timotheus.pokorra@om.org>
Date: Fri, 29 Nov 2013 14:36:00 +0100
Subject: [PATCH] todo backport: fix problem with gift batch export, in
 european format (decimal comma). see also
 https://tracker.openpetra.org/view.php?id=2541

---
 .../Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs | 9 +++++++--
 csharp/ICT/Petra/Server/lib/MFinance/Gift/Gift.Exporting.cs      | 4 +++-
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs b/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
index c5e93b1..96f54d4 100644
--- a/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
+++ b/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
@@ -148,6 +148,11 @@ public string NumberFormat
             set
             {
                 cmbNumberFormat.SelectedIndex = (value.ToLower() == "American".ToLower() ? 0 : 1);
+
+                if ((cmbDelimiter.GetSelectedString() == ",") && (value.ToLower() == "European".ToLower()))
+                {
+                    cmbDelimiter.SetSelectedString(";");
+                }
             }
         }
 
@@ -300,7 +305,7 @@ public void ExportBatches(bool AWithInteractionOnSuccess = true)
 
                 Hashtable requestParams = new Hashtable();
                 requestParams.Add("ALedgerNumber", FLedgerNumber);
-                requestParams.Add("Delimiter", ConvertDelimiter(cmbDelimiter.GetSelectedString(), false));
+                requestParams.Add("Delimiter", delimiter);
                 requestParams.Add("DateFormatString", cmbDateFormat.GetSelectedString());
                 requestParams.Add("Summary", rbtSummary.Checked);
                 requestParams.Add("IncludeUnposted", chkIncludeUnposted.Checked);
@@ -309,7 +314,7 @@ public void ExportBatches(bool AWithInteractionOnSuccess = true)
                 requestParams.Add("RecipientNumber", Convert.ToInt64(txtDetailRecipientKey.Text));
                 requestParams.Add("FieldNumber", Convert.ToInt64(txtDetailFieldKey.Text));
                 requestParams.Add("DateForSummary", dtpDateSummary.Date);
-                requestParams.Add("NumberFormat", ConvertNumberFormat(cmbNumberFormat));
+                requestParams.Add("NumberFormat", numberFormat);
                 requestParams.Add("ExtraColumns", chkExtraColumns.Checked);
 
                 if (rbtBatchNumberSelection.Checked)
diff --git a/csharp/ICT/Petra/Server/lib/MFinance/Gift/Gift.Exporting.cs b/csharp/ICT/Petra/Server/lib/MFinance/Gift/Gift.Exporting.cs
index 18874ad..b47a231 100644
--- a/csharp/ICT/Petra/Server/lib/MFinance/Gift/Gift.Exporting.cs
+++ b/csharp/ICT/Petra/Server/lib/MFinance/Gift/Gift.Exporting.cs
@@ -534,7 +534,9 @@ void WriteCurrency(decimal currencyField, bool bLineEnd = false)
             else
             {
                 FStringWriter.Write(quote);
-                FStringWriter.Write(StringHelper.FormatUsingCurrencyCode(currencyField, FCurrencyCode));
+                // see https://tracker.openpetra.org/view.php?id=2541
+                //FStringWriter.Write(StringHelper.FormatUsingCurrencyCode(currencyField, FCurrencyCode, FCultureInfo));
+                FStringWriter.Write(String.Format(FCultureInfo, "{0:g}", currencyField));
                 FStringWriter.Write(quote);
             }

diff --git a/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs b/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
index cef2105..82874f8 100644
--- a/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
+++ b/csharp/ICT/Petra/Client/MFinance/Gui/Gift/GiftBatchExport.ManualCode.cs
@@ -140,6 +140,17 @@ namespace Ict.Petra.Client.MFinance.Gui.Gift
             }
         }
 
+        /// <summary>
+        /// set the number format: American or European
+        /// </summary>
+        public string NumberFormat
+        {
+            set
+            {
+                cmbNumberFormat.SelectedIndex = (value.ToLower() == "American".ToLower() ? 0 : 1);
+            }
+        }
+
         const String sSpace = "[SPACE]";
         private String ConvertDelimiter(String Delimiter, bool displayform)
         {
@@ -221,11 +232,16 @@ namespace Ict.Petra.Client.MFinance.Gui.Gift
             TUserDefaults.SaveChangedUserDefaults();
         }
 
+        private void ExportBatches(object sender, EventArgs e)
+        {
+            ExportBatches();
+        }
+
         /// <summary>
         /// this supports the batch export files from Petra 2.x.
         /// Each line starts with a type specifier, B for batch, J for journal, T for transaction
         /// </summary>
-        public void ExportBatches(object sender, EventArgs e)
+        public void ExportBatches(bool AWithInteractionOnSuccess = true)
         {
             StreamWriter sw1 = null;
 
@@ -358,10 +374,14 @@ namespace Ict.Petra.Client.MFinance.Gui.Gift
                 sw1.Close();
 
                 SaveUserDefaults();
-                MessageBox.Show(Catalog.GetString("Gift Batches Exported successfully."),
-                    Catalog.GetString("Gift Batch Export"),
-                    MessageBoxButtons.OK,
-                    MessageBoxIcon.Information);
+
+                if (AWithInteractionOnSuccess)
+                {
+                    MessageBox.Show(Catalog.GetString("Gift Batches Exported successfully."),
+                        Catalog.GetString("Gift Batch Export"),
+                        MessageBoxButtons.OK,
+                        MessageBoxIcon.Information);
+                }
             }
             catch (Exception ex)
             {
